<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClash 节点管理面板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #dee2e6;
            --hover-bg: #f8f9fa;
        }
        
        [data-theme="dark"] {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --border-color: #404040;
            --hover-bg: #3a3a3a;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 1400px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        
        .status-card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .status-header {
            padding: 15px 20px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .status-content {
            padding: 20px;
        }
        
        .btn-custom {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        .status-stopped {
            background-color: var(--danger-color);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .nodes-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
        }
        
        .node-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        .node-item:hover {
            background-color: var(--hover-bg);
        }
        
        .node-item:last-child {
            border-bottom: none;
        }
        
        .node-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary-color);
        }
        
        .node-type-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .node-type-ss {
            background-color: #ff6b6b;
            color: white;
        }
        
        .node-type-vmess {
            background-color: #4ecdc4;
            color: white;
        }
        
        .node-type-vless {
            background-color: #45b7d1;
            color: white;
        }
        
        .node-type-trojan {
            background-color: #96ceb4;
            color: white;
        }
        
        .node-url {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #888;
            word-break: break-all;
            margin-top: 4px;
        }
        
        .node-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        /* 选项卡样式 */
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: #f8f9fa;
            border: none;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: transparent;
            border: none;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .tab-content {
            padding-top: 20px;
        }
        
                .node-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .node-item:hover .node-actions {
            opacity: 1;
        }
        
        .nodes-textarea {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            min-height: 200px;
        }
        
        .nodes-textarea {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            min-height: 200px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .system-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            margin-bottom: 10px;
        }
        
        .info-label {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .loading {
            display: none;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 头部 -->
            <div class="header d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-shield-check"></i> OpenClash 节点管理面板</h1>
                    <p class="mb-0">自动化节点同步与管理工具</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" id="theme-toggle" onclick="toggleTheme()">
                        <i class="bi bi-moon" id="theme-icon"></i>
                        <span id="theme-text">深色模式</span>
                    </button>
                </div>
            </div>
            
            <div class="p-4">
                <!-- 状态卡片 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="status-card">
                            <div class="status-header">
                                <i class="bi bi-cpu"></i> 守护进程状态
                            </div>
                            <div class="status-content">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="status-indicator" id="watchdog-status-indicator"></span>
                                    <span id="watchdog-status-text">检查中...</span>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-success btn-custom" onclick="startWatchdog()">
                                        <i class="bi bi-play-circle"></i> 启动守护进程
                                    </button>
                                    <button class="btn btn-danger btn-custom" onclick="stopWatchdog()">
                                        <i class="bi bi-stop-circle"></i> 停止守护进程
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="status-card">
                            <div class="status-header">
                                <i class="bi bi-gear"></i> OpenClash 状态
                            </div>
                            <div class="status-content">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="status-indicator" id="openclash-status-indicator"></span>
                                    <span id="openclash-status-text">检查中...</span>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-warning btn-custom" onclick="restartOpenClash()">
                                        <i class="bi bi-arrow-clockwise"></i> 重启 OpenClash
                                    </button>
                                    <button class="btn btn-info btn-custom" onclick="manualSync()">
                                        <i class="bi bi-arrow-repeat"></i> 手动同步
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 节点管理 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="status-card">
                            <div class="status-header">
                                <i class="bi bi-list-ul"></i> 节点管理
                                <small class="text-muted ms-2">支持 ss:// vmess:// vless:// trojan:// 协议</small>
                            </div>
                            <div class="status-content">
                                <!-- 选项卡导航 -->
                                <ul class="nav nav-tabs mb-3" id="nodesTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="nodes-list-tab" data-bs-toggle="tab" data-bs-target="#nodes-list" type="button" role="tab">
                                            <i class="bi bi-list-ul"></i> 节点列表
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="nodes-edit-tab" data-bs-toggle="tab" data-bs-target="#nodes-edit" type="button" role="tab">
                                            <i class="bi bi-pencil-square"></i> 编辑节点
                                        </button>
                                    </li>
                                </ul>
                                
                                <!-- 选项卡内容 -->
                                <div class="tab-content" id="nodesTabContent">
                                    <!-- 节点列表选项卡 -->
                                    <div class="tab-pane fade show active" id="nodes-list" role="tabpanel">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">当前节点</h6>
                                            <div>
                                                <button class="btn btn-sm btn-outline-info" onclick="showNodeGroups()">
                                                    <i class="bi bi-collection"></i> 分组查看
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" onclick="refreshNodesList()">
                                                    <i class="bi bi-arrow-clockwise"></i> 刷新
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedNodes()">
                                                    <i class="bi bi-trash"></i> 删除选中
                                                </button>
                                            </div>
                                        </div>
                                        <div id="nodes-list-container">
                                            <div class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <p class="mt-2">正在加载节点列表...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 节点编辑选项卡 -->
                                    <div class="tab-pane fade" id="nodes-edit" role="tabpanel">
                                        <div class="mb-3">
                                            <label for="nodes-textarea" class="form-label">节点链接（一行一个）</label>
                                            <textarea class="form-control nodes-textarea" id="nodes-textarea" rows="12" 
                                                      placeholder="# 在此粘贴你的节点链接，一行一个，支持 ss:// vmess:// vless:// trojan://协议">{{ nodes_content }}</textarea>
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-custom" onclick="saveNodes()">
                                                <i class="bi bi-save"></i> 保存节点
                                            </button>
                                            <button class="btn btn-secondary btn-custom" onclick="clearNodes()">
                                                <i class="bi bi-trash"></i> 清空节点
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 日志和系统信息 -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="status-card">
                            <div class="status-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-journal-text"></i> 运行日志</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearLog()">
                                        <i class="bi bi-trash"></i> 清空日志
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshLog()">
                                        <i class="bi bi-arrow-clockwise"></i> 刷新
                                    </button>
                                </div>
                            </div>
                            <div class="status-content">
                                <div class="log-container" id="log-container">
                                    {{ log_content }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="status-card">
                            <div class="status-header">
                                <i class="bi bi-info-circle"></i> 系统信息
                            </div>
                            <div class="status-content">
                                <div id="system-info">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                        <p class="mt-2">正在获取系统信息...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast 通知 -->
    <div class="toast-container"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let statusUpdateInterval;
        let selectedNodes = new Set();
        
        // 主题切换功能
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.className = 'bi bi-moon';
                themeText.textContent = '深色模式';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'bi bi-sun';
                themeText.textContent = '浅色模式';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // 初始化主题
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'bi bi-sun';
                themeText.textContent = '浅色模式';
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            updateStatus();
            loadSystemInfo();
            loadNodesList();
            
            // 每5秒更新状态
            statusUpdateInterval = setInterval(updateStatus, 5000);
        });
        
        // 更新状态
        function updateStatus() {
            fetch('/api/get_status')
                .then(response => response.json())
                .then(data => {
                    updateWatchdogStatus(data.watchdog_status, data.watchdog_pid);
                    updateOpenClashStatus(data.openclash_status);
                    updateLogContent(data.log_content);
                })
                .catch(error => {
                    console.error('获取状态失败:', error);
                });
        }
        
        // 更新守护进程状态
        function updateWatchdogStatus(status, pid) {
            const indicator = document.getElementById('watchdog-status-indicator');
            const text = document.getElementById('watchdog-status-text');
            
            if (status) {
                indicator.className = 'status-indicator status-running';
                text.textContent = `运行中 (PID: ${pid})`;
            } else {
                indicator.className = 'status-indicator status-stopped';
                text.textContent = '已停止';
            }
        }
        
        // 更新OpenClash状态
        function updateOpenClashStatus(status) {
            const indicator = document.getElementById('openclash-status-indicator');
            const text = document.getElementById('openclash-status-text');
            
            if (status) {
                indicator.className = 'status-indicator status-running';
                text.textContent = '运行中';
            } else {
                indicator.className = 'status-indicator status-stopped';
                text.textContent = '已停止';
            }
        }
        
        // 更新日志内容
        function updateLogContent(content) {
            const container = document.getElementById('log-container');
            container.textContent = content;
            container.scrollTop = container.scrollHeight;
        }
        
        // 加载系统信息
        function loadSystemInfo() {
            fetch('/api/system_info')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('system-info');
                    if (data.error) {
                        container.innerHTML = `<div class="text-danger">获取系统信息失败: ${data.error}</div>`;
                        return;
                    }
                    
                    let html = '';
                    if (data.memory) {
                        html += `<div class="info-item">
                            <div class="info-label">内存使用:</div>
                            <pre class="mb-2" style="font-size: 11px;">${data.memory}</pre>
                        </div>`;
                    }
                    if (data.disk) {
                        html += `<div class="info-item">
                            <div class="info-label">磁盘使用:</div>
                            <pre class="mb-2" style="font-size: 11px;">${data.disk}</pre>
                        </div>`;
                    }
                    if (data.cpu_load) {
                        html += `<div class="info-item">
                            <div class="info-label">CPU负载:</div>
                            <pre class="mb-2" style="font-size: 11px;">${data.cpu_load}</pre>
                        </div>`;
                    }
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('system-info').innerHTML = 
                        `<div class="text-danger">获取系统信息失败: ${error}</div>`;
                });
        }
        
        // 显示通知
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // 自动移除
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
        
        // 保存节点
        function saveNodes() {
            const content = document.getElementById('nodes-textarea').value;
            
            fetch('/api/save_nodes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `content=${encodeURIComponent(content)}`
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message, data.success ? 'success' : 'danger');
                if (data.success) {
                    setTimeout(() => {
                        loadNodesList();
                        updateStatus();
                        // 切换到节点列表选项卡
                        const listTab = new bootstrap.Tab(document.getElementById('nodes-list-tab'));
                        listTab.show();
                    }, 1000);
                }
            })
            .catch(error => {
                showToast('保存失败: ' + error, 'danger');
            });
        }
        
        // 清空节点
        function clearNodes() {
            if (confirm('确定要清空所有节点吗？')) {
                document.getElementById('nodes-textarea').value = '';
                showToast('节点已清空', 'info');
            }
        }
        
        // 启动守护进程
        function startWatchdog() {
            fetch('/api/start_watchdog', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showToast(data.message, data.success ? 'success' : 'danger');
                    if (data.success) {
                        setTimeout(updateStatus, 1000);
                    }
                })
                .catch(error => {
                    showToast('启动失败: ' + error, 'danger');
                });
        }
        
        // 停止守护进程
        function stopWatchdog() {
            if (confirm('确定要停止守护进程吗？')) {
                fetch('/api/stop_watchdog', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        showToast(data.message, data.success ? 'success' : 'danger');
                        if (data.success) {
                            setTimeout(updateStatus, 1000);
                        }
                    })
                    .catch(error => {
                        showToast('停止失败: ' + error, 'danger');
                    });
            }
        }
        
        // 手动同步
        function manualSync() {
            if (confirm('确定要手动同步节点吗？')) {
                fetch('/api/manual_sync', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        showToast(data.message, data.success ? 'success' : 'danger');
                        if (data.success) {
                            setTimeout(updateStatus, 2000);
                        }
                    })
                    .catch(error => {
                        showToast('同步失败: ' + error, 'danger');
                    });
            }
        }
        
        // 重启OpenClash
        function restartOpenClash() {
            if (confirm('确定要重启 OpenClash 吗？')) {
                fetch('/api/restart_openclash', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        showToast(data.message, data.success ? 'success' : 'danger');
                        if (data.success) {
                            setTimeout(updateStatus, 3000);
                        }
                    })
                    .catch(error => {
                        showToast('重启失败: ' + error, 'danger');
                    });
            }
        }
        
        // 清空日志
        function clearLog() {
            if (confirm('确定要清空日志吗？')) {
                fetch('/api/clear_log', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        showToast(data.message, data.success ? 'success' : 'danger');
                        if (data.success) {
                            setTimeout(updateStatus, 1000);
                        }
                    })
                    .catch(error => {
                        showToast('清空失败: ' + error, 'danger');
                    });
            }
        }
        
        // 刷新日志
        function refreshLog() {
            updateStatus();
            showToast('日志已刷新', 'info');
        }
        
        // 加载节点列表
        function loadNodesList() {
            fetch('/api/get_nodes')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderNodesList(data.nodes);
                    } else {
                        showToast('加载节点列表失败', 'danger');
                    }
                })
                .catch(error => {
                    console.error('加载节点列表失败:', error);
                    showToast('加载节点列表失败', 'danger');
                });
        }
        
        // 渲染节点列表
        function renderNodesList(nodes) {
            const container = document.getElementById('nodes-list-container');
            
            if (nodes.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">暂无节点</div>';
                return;
            }
            
            let html = '<div class="nodes-list">';
            nodes.forEach((node, index) => {
                const nodeTypeClass = getNodeTypeClass(node.type);
                const nodeName = node.name || `节点 ${index + 1}`;
                
                html += `
                    <div class="node-item d-flex justify-content-between align-items-start" data-index="${node.index}">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <input type="checkbox" class="form-check-input me-2" 
                                       onchange="toggleNodeSelection(${node.index})" 
                                       id="node-${node.index}">
                                <span class="node-type-badge ${nodeTypeClass}">${node.type}</span>
                                <span class="node-name ms-2 fw-bold">${nodeName}</span>
                            </div>
                            <div class="node-url text-muted small">
                                <i class="bi bi-link-45deg"></i> 
                                <span class="url-text" style="font-family: monospace; word-break: break-all;">${node.url}</span>
                            </div>
                        </div>
                        <div class="node-actions">
                            <button class="btn btn-sm btn-outline-info me-1" onclick="testNodeSpeed(${node.index})" title="测速">
                                <i class="bi bi-speedometer2"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSingleNode(${node.index})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // 获取节点类型CSS类
        function getNodeTypeClass(type) {
            switch (type) {
                case 'Shadowsocks': return 'node-type-ss';
                case 'VMess': return 'node-type-vmess';
                case 'VLESS': return 'node-type-vless';
                case 'Trojan': return 'node-type-trojan';
                default: return 'node-type-ss';
            }
        }
        
        // 切换节点选择状态
        function toggleNodeSelection(index) {
            if (selectedNodes.has(index)) {
                selectedNodes.delete(index);
                document.querySelector(`[data-index="${index}"]`).classList.remove('selected');
            } else {
                selectedNodes.add(index);
                document.querySelector(`[data-index="${index}"]`).classList.add('selected');
            }
        }
        
        // 显示节点分组
        function showNodeGroups() {
            fetch('/api/get_node_groups')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('nodes-list-container');
                        let html = '<div class="node-groups">';
                        
                        for (const [groupType, groups] of Object.entries(data.groups)) {
                            html += `<div class="group-section mb-4">
                                <h6 class="group-title">${groupType}</h6>`;
                            
                            for (const [groupName, nodeIndices] of Object.entries(groups)) {
                                html += `<div class="group-item mb-3">
                                    <div class="group-header d-flex justify-content-between align-items-center">
                                        <span class="group-name">${groupName}</span>
                                        <span class="group-count badge bg-secondary">${nodeIndices.length} 个节点</span>
                                    </div>
                                    <div class="group-nodes">`;
                                
                                // 这里可以显示该分组下的节点列表
                                html += `<small class="text-muted">节点索引: ${nodeIndices.join(', ')}</small>`;
                                
                                html += `</div></div>`;
                            }
                            
                            html += '</div>';
                        }
                        
                        html += '</div>';
                        container.innerHTML = html;
                        showToast('分组信息已加载', 'success');
                    } else {
                        showToast(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showToast('获取分组失败: ' + error, 'danger');
                });
        }
        
        // 更新编辑选项卡内容
        function updateEditTabContent() {
            // 重新加载节点文件内容到文本框，确保与服务器同步
            fetch('/api/get_nodes')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 获取当前文本框的注释部分
                        const textarea = document.getElementById('nodes-textarea');
                        const currentContent = textarea.value;
                        const lines = currentContent.split('\n');
                        const comments = lines.filter(line => {
                            line = line.trim();
                            return line.startsWith('#') || line === '';
                        });
                        
                        // 构建新的内容：保留注释，移除已删除的节点
                        const validNodes = data.nodes.map(node => node.full_line);
                        const newContent = comments.join('\n') + '\n' + validNodes.join('\n');
                        textarea.value = newContent;
                    }
                })
                .catch(error => {
                    console.error('更新编辑选项卡失败:', error);
                });
        }
        
        // 刷新节点列表
        function refreshNodesList() {
            loadNodesList();
            showToast('节点列表已刷新', 'info');
        }
        
        // 测试节点速度
        function testNodeSpeed(index) {
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            
            // 显示测速中状态
            button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            button.disabled = true;
            
            fetch('/api/test_node_speed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ index: index })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statusClass = data.status === 'success' ? 'success' : 
                                      data.status === 'warning' ? 'warning' : 'danger';
                    showToast(`${data.node_name}: 延迟 ${data.latency}ms, 速度 ${data.speed}Mbps`, statusClass);
                } else {
                    showToast(data.message, 'danger');
                }
            })
            .catch(error => {
                showToast('测速失败: ' + error, 'danger');
            })
            .finally(() => {
                // 恢复按钮状态
                button.innerHTML = originalContent;
                button.disabled = false;
            });
        }
        
        // 删除单个节点
        function deleteSingleNode(index) {
            if (confirm(`确定要删除节点 #${index + 1} 吗？`)) {
                fetch('/api/delete_node', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ index: index })
                })
                .then(response => response.json())
                .then(data => {
                    showToast(data.message, data.success ? 'success' : 'danger');
                    if (data.success) {
                        setTimeout(() => {
                            loadNodesList();
                            updateStatus();
                            // 同步更新编辑选项卡的内容
                            updateEditTabContent();
                        }, 1000);
                    }
                })
                .catch(error => {
                    showToast('删除节点失败: ' + error, 'danger');
                });
            }
        }
        
        // 删除选中的节点
        function deleteSelectedNodes() {
            if (selectedNodes.size === 0) {
                showToast('请先选择要删除的节点', 'warning');
                return;
            }
            
            const indices = Array.from(selectedNodes);
            if (confirm(`确定要删除选中的 ${indices.length} 个节点吗？`)) {
                fetch('/api/delete_nodes_batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ indices: indices })
                })
                .then(response => response.json())
                .then(data => {
                    showToast(data.message, data.success ? 'success' : 'danger');
                    if (data.success) {
                        selectedNodes.clear();
                        setTimeout(() => {
                            loadNodesList();
                            updateStatus();
                            // 同步更新编辑选项卡的内容
                            updateEditTabContent();
                        }, 1000);
                    }
                })
                .catch(error => {
                    showToast('批量删除节点失败: ' + error, 'danger');
                });
            }
        }
        
        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });
    </script>
</body>
</html> 